kind: pipeline
name: default

workspace:
  base: /go
  path: src/github.com/VideoCoin/go-videocoin

steps:
  - name: test
    image: golang:1.10
    commands:
      - make lint
      - make test
    when:
      event: [pull_request]

  - name: deploy vid docker file
    image: plugins/docker
    settings:
      repo: videocoinnetwork/vid
      dockerfile: containers/vid.Dockerfile
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      auto_tag: true
      tags:
        - dev
      build_args:
        - CI
        - DRONE
        - DRONE_REPO
        - DRONE_COMMIT_SHA
        - DRONE_COMMIT_BRANCH
        - DRONE_TAG
        - DRONE_BUILD_NUMBER
        - DRONE_BUILD_EVENT
    when:
      event: [push, tag]
      branch: [dev, master]

  - name: build artifacts
    image: videocoinnetwork/golang:latest
    environment:
      DOCKER_HOST: tcp://docker:2375
    commands:
      - make vid-cross
      - make vid-compress
    when:
      event: [push, tag]
      branch: [dev, master]

  - name: upload artifacts
    image: plugins/gcs
    settings:
      source: build/bin
      target: releases-videocoin-io
      acl: allUsers:READER
      cache_control: public,max-age=3600
      token:
        from_secret: google_storage_object_creator_auth
    when:
      event: [push, tag]
      branch: [dev, master]

  - name: slack
    image: plugins/slack
    settings:
      webhook:
        from_secret: slack_app_webhook
      channel: videocoin-ci
      template: >
        {{#success build.status}}
          build {{build.number}} succeeded. Good job.
        {{else}}
          build {{build.number}} failed. {{build.author}}, fix me please.
        {{/success}}
    when:
      event: [tag, pull_request]

services:
  - name: docker
    image: docker:18.06.1-ce-dind
    command: ["-l", "fatal"]
    privileged: true
